services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    expose:
      - "8000"
    environment:
      - DEBUG=false
      - HOST=0.0.0.0
      - PORT=8000
      - DATABASE_URL=sqlite:////app/data/orion_analytics.db
      # When behind Nginx (/api), the browser is same-origin, so CORS rarely matters.
      - CORS_ORIGINS=["http://localhost","http://127.0.0.1"]
    volumes:
      - orion-data:/app/data
      - orion-models:/app/models
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: deploy/ec2/nginx/Dockerfile
    ports:
      - "${ORION_WEB_PORT:-80}:80"
    depends_on:
      - backend
    # Password must live in a TXT file on the host (requested). This mount makes it persistent.
    volumes:
      - ./secrets:/run/secrets
    environment:
      - ORION_AUTH_USER=${ORION_AUTH_USER:-orion}
      - ORION_AUTH_PASSWORD_FILE=${ORION_AUTH_PASSWORD_FILE:-/run/secrets/orion_password.txt}
    restart: unless-stopped

volumes:
  orion-data:
  orion-models:

